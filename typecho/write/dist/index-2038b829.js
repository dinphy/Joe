import{c as countColumn,L as Language,d as defineLanguageFacet,i as indentService,s as syntaxTree,T as Tree,N as NodeType,a as styleTags,l as languageDataProp,g as getIndentUnit,b as NodeSet,t as tags}from"./index.js";function countCol(t,e,s,n=0,r=0){return null==e&&-1==(e=t.search(/[^\s\u00a0]/))&&(e=t.length),countColumn(t.slice(n,e),r,s)}class StringStream{constructor(t,e,s){this.string=t,this.tabSize=e,this.indentUnit=s,this.pos=0,this.start=0,this.lastColumnPos=0,this.lastColumnValue=0}eol(){return this.pos>=this.string.length}sol(){return 0==this.pos}peek(){return this.string.charAt(this.pos)||void 0}next(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)}eat(t){var e=this.string.charAt(this.pos);let s;if(s="string"==typeof t?e==t:e&&(t instanceof RegExp?t.test(e):t(e)),s)return++this.pos,e}eatWhile(t){for(var e=this.pos;this.eat(t););return this.pos>e}eatSpace(){for(var t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t}skipToEnd(){this.pos=this.string.length}skipTo(t){t=this.string.indexOf(t,this.pos);if(-1<t)return this.pos=t,!0}backUp(t){this.pos-=t}column(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countCol(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue}indentation(){return countCol(this.string,null,this.tabSize)}match(t,e,s){if("string"==typeof t){var n=t=>s?t.toLowerCase():t;return n(this.string.substr(this.pos,t.length))==n(t)?(!1!==e&&(this.pos+=t.length),!0):null}t=this.string.slice(this.pos).match(t);return t&&0<t.index?null:(t&&!1!==e&&(this.pos+=t[0].length),t)}current(){return this.string.slice(this.start,this.pos)}}function fullParser(t){return{token:t.token,blankLine:t.blankLine||(()=>{}),startState:t.startState||(()=>!0),copyState:t.copyState||defaultCopyState,indent:t.indent||(()=>null),languageData:t.languageData||{}}}function defaultCopyState(e){if("object"!=typeof e)return e;let s={};for(var n in e){let t=e[n];s[n]=t instanceof Array?t.slice():t}return s}class StreamLanguage extends Language{constructor(t){var e=defineLanguageFacet(t.languageData),t=fullParser(t);super(e,{startParse:(t,e,s)=>new Parse(this,t,e,s)},docID(e),[indentService.of((t,e)=>this.getIndent(t,e))]),this.streamParser=t,this.stateAfter=new WeakMap}static define(t){return new StreamLanguage(t)}getIndent(t,e){let s=syntaxTree(t.state),n=s.resolve(e);for(;n&&n.type!=this.topNode;)n=n.parent;if(!n)return null;let r=findState(this,s,0,n.from,e),i,a;if(i=r?(a=r.state,r.pos+1):(a=this.streamParser.startState(t.unit),0),1e4<e-i)return null;for(;i<e;){var o=t.state.doc.lineAt(i),h=Math.min(e,o.to);if(o.length)for(var l=new StringStream(o.text,t.state.tabSize,t.unit);l.pos<h-o.from;)readToken(this.streamParser.token,l,a);else this.streamParser.blankLine(a,t.unit);if(h==e)break;i=o.to+1}var{text:u}=t.state.doc.lineAt(e);return this.streamParser.indent(a,/^\s*(.*)/.exec(u)[1],t)}get allowsNesting(){return!1}}function findState(e,s,n,r,i){var t=r<=n&&n+s.length<=i&&e.stateAfter.get(s);if(t)return{state:e.streamParser.copyState(t),pos:n+s.length};for(let t=s.children.length-1;0<=t;t--){var a=s.children[t],o=n+s.positions[t],o=a instanceof Tree&&o<i&&findState(e,a,o,r,i);if(o)return o}return null}function cutTree(e,s,n,r,i){if(i&&n<=0&&r>=s.length)return s;i||s.type!=e.topNode||(i=!0);for(let t=s.children.length-1;0<=t;t--){var a=s.positions[t]+n,o=s.children[t];if(a<r&&o instanceof Tree){if(!(o=cutTree(e,o,n-a,r-a,i)))break;return i?new Tree(s.type,s.children.slice(0,t).concat(o),s.positions.slice(0,t+1),a+o.length):o}}return null}function findStartInFragments(s,t,n,e){for(var r of t){let t=r.from<=n&&r.to>n&&findState(s,r.tree,0-r.offset,n,r.to),e;if(t&&(e=cutTree(s,r.tree,n+r.offset,t.pos+r.offset,!1)))return{state:t.state,tree:e}}return{state:s.streamParser.startState(getIndentUnit(e)),tree:Tree.empty}}class Parse{constructor(t,e,s,n){this.lang=t,this.input=e,this.startPos=s,this.context=n,this.chunks=[],this.chunkPos=[],this.chunk=[];var{state:e,tree:t}=findStartInFragments(t,n.fragments,s,n.state);this.state=e,this.pos=this.chunkStart=s+t.length,t.length&&(this.chunks.push(t),this.chunkPos.push(0)),this.pos<n.viewport.from-1e5&&(this.state=this.lang.streamParser.startState(getIndentUnit(n.state)),n.skipUntilInView(this.pos,n.viewport.from),this.pos=n.viewport.from)}advance(){for(var t=Math.min(this.context.viewport.to,this.input.length,this.chunkStart+2048);this.pos<t;)this.parseLine();return this.chunkStart<this.pos&&this.finishChunk(),t<this.input.length&&this.pos<this.context.viewport.to?null:(this.context.skipUntilInView(this.pos,this.input.length),this.finish())}parseLine(){let t=this.input.lineAfter(this.pos),{streamParser:e}=this.lang,s=new StringStream(t,this.context?this.context.state.tabSize:4,getIndentUnit(this.context.state));if(s.eol())e.blankLine(this.state,s.indentUnit);else for(;!s.eol();){var n=readToken(e.token,s,this.state);n&&this.chunk.push(tokenID(n),this.pos+s.start,this.pos+s.pos,4)}this.pos+=t.length,this.pos<this.input.length&&this.pos++}finishChunk(){var t=Tree.build({buffer:this.chunk,start:this.chunkStart,length:this.pos-this.chunkStart,nodeSet:nodeSet,topID:0,maxBufferLength:2048});this.lang.stateAfter.set(t,this.lang.streamParser.copyState(this.state)),this.chunks.push(t),this.chunkPos.push(this.chunkStart-this.startPos),this.chunk=[],this.chunkStart=this.pos}finish(){return new Tree(this.lang.topNode,this.chunks,this.chunkPos,this.pos-this.startPos).balance()}forceFinish(){return this.finish()}}function readToken(e,s,n){s.start=s.pos;for(let t=0;t<10;t++){var r=e(s,n);if(s.pos>s.start)return r}throw new Error("Stream parser failed to advance stream.")}const tokenTable=Object.create(null),typeArray=[NodeType.none],nodeSet=new NodeSet(typeArray),warned=[];function tokenID(t){return t?tokenTable[t]||(tokenTable[t]=createTokenType(t)):0}for(let[t,e]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])tokenTable[t]=tokenID(e);function warnForPart(t,e){-1<warned.indexOf(t)||(warned.push(t),console.warn(e))}function createTokenType(t){let e=null;for(var s of t.split(".")){let t=tags[s];t?"function"==typeof t?e?e=t(e):warnForPart(s,`Modifier ${s} used at start of tag`):e?warnForPart(s,`Tag ${s} used as modifier`):e=t:warnForPart(s,`Unknown highlighting tag ${s}`)}if(!e)return 0;t=t.replace(/ /g,"_"),t=NodeType.define({id:typeArray.length,name:t,props:[styleTags({[t]:e})]});return typeArray.push(t),t.id}function docID(t){var e=NodeType.define({id:typeArray.length,name:"Document",props:[languageDataProp.add(()=>t)]});return typeArray.push(e),e}export{StreamLanguage,StringStream};
