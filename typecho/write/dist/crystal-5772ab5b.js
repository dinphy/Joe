function wordRegExp(e,t){return new RegExp((t?"":"^")+"(?:"+e.join("|")+")"+(t?"$":"\\b"))}function chain(e,t,n){return n.tokenize.push(e),e(t,n)}var operators=/^(?:[-+/%|&^]|\*\*?|[<>]{2})/,conditionalOperators=/^(?:[=!]~|===|<=>|[<>=!]=?|[|&]{2}|~)/,indexingOperators=/^(?:\[\][?=]?)/,anotherOperators=/^(?:\.(?:\.{2})?|->|[?:])/,idents=/^[a-z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,types=/^[A-Z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,keywords=wordRegExp(["abstract","alias","as","asm","begin","break","case","class","def","do","else","elsif","end","ensure","enum","extend","for","fun","if","include","instance_sizeof","lib","macro","module","next","of","out","pointerof","private","protected","rescue","return","require","select","sizeof","struct","super","then","type","typeof","uninitialized","union","unless","until","when","while","with","yield","__DIR__","__END_LINE__","__FILE__","__LINE__"]),atomWords=wordRegExp(["true","false","nil","self"]),indentKeywordsArray=["def","fun","macro","class","module","struct","lib","enum","union","do","for"],indentKeywords=wordRegExp(indentKeywordsArray),indentExpressionKeywordsArray=["if","unless","case","while","until","begin","then"],indentExpressionKeywords=wordRegExp(indentExpressionKeywordsArray),dedentKeywordsArray=["end","else","elsif","rescue","ensure"],dedentKeywords=wordRegExp(dedentKeywordsArray),dedentPunctualsArray=["\\)","\\}","\\]"],dedentPunctuals=new RegExp("^(?:"+dedentPunctualsArray.join("|")+")$"),nextTokenizer={def:tokenFollowIdent,fun:tokenFollowIdent,macro:tokenMacroDef,class:tokenFollowType,module:tokenFollowType,struct:tokenFollowType,lib:tokenFollowType,enum:tokenFollowType,union:tokenFollowType},matching={"[":"]","{":"}","(":")","<":">"};function tokenBase(e,t){if(e.eatSpace())return null;if("\\"!=t.lastToken&&e.match("{%",!1))return chain(tokenMacro("%","%"),e,t);if("\\"!=t.lastToken&&e.match("{{",!1))return chain(tokenMacro("{","}"),e,t);if("#"==e.peek())return e.skipToEnd(),"comment";if(e.match(idents))return e.eat(/[?!]/),o=e.current(),e.eat(":")?"atom":"."==t.lastToken?"property":keywords.test(o)?(indentKeywords.test(o)?"fun"==o&&0<=t.blocks.indexOf("lib")||"def"==o&&"abstract"==t.lastToken||(t.blocks.push(o),t.currentIndent+=1):"operator"!=t.lastStyle&&t.lastStyle||!indentExpressionKeywords.test(o)?"end"==o&&(t.blocks.pop(),--t.currentIndent):(t.blocks.push(o),t.currentIndent+=1),nextTokenizer.hasOwnProperty(o)&&t.tokenize.push(nextTokenizer[o]),"keyword"):atomWords.test(o)?"atom":"variable";if(e.eat("@"))return"["==e.peek()?chain(tokenNest("[","]","meta"),e,t):(e.eat("@"),e.match(idents)||e.match(types),"propertyName");if(e.match(types))return"tag";if(e.eat(":"))return e.eat('"')?chain(tokenQuote('"',"atom",!1),e,t):e.match(idents)||e.match(types)||e.match(operators)||e.match(conditionalOperators)||e.match(indexingOperators)?"atom":(e.eat(":"),"operator");if(e.eat('"'))return chain(tokenQuote('"',"string",!0),e,t);if("%"!=e.peek())return(o=e.match(/^<<-('?)([A-Z]\w*)\1/))?chain(tokenHereDoc(o[2],!o[1]),e,t):e.eat("'")?(e.match(/^(?:[^']|\\(?:[befnrtv0'"]|[0-7]{3}|u(?:[0-9a-fA-F]{4}|\{[0-9a-fA-F]{1,6}\})))/),e.eat("'"),"atom"):e.eat("0")?(e.eat("x")?e.match(/^[0-9a-fA-F]+/):e.eat("o")?e.match(/^[0-7]+/):e.eat("b")&&e.match(/^[01]+/),"number"):e.eat(/^\d/)?(e.match(/^\d*(?:\.\d+)?(?:[eE][+-]?\d+)?/),"number"):e.match(operators)?(e.eat("="),"operator"):e.match(conditionalOperators)||e.match(anotherOperators)?"operator":(o=e.match(/[({[]/,!1))?chain(tokenNest(o=o[0],matching[o],null),e,t):e.eat("\\")?(e.next(),"meta"):(e.next(),null);var n,r="string",o=!0;if(e.match("%r"))r="string.special",n=e.next();else if(e.match("%w"))o=!1,n=e.next();else if(e.match("%q"))o=!1,n=e.next();else{if(!(n=e.match(/^%([^\w\s=])/)))return e.match(/^%[a-zA-Z0-9_\u009F-\uFFFF]*/)?"meta":"operator";n=n[1]}return chain(tokenQuote(n=matching.hasOwnProperty(n)?matching[n]:n,r,o),e,t)}function tokenNest(r,o,a,i){return function(e,t){if(!i&&e.match(r))return t.tokenize[t.tokenize.length-1]=tokenNest(r,o,a,!0),t.currentIndent+=1,a;var n=tokenBase(e,t);return e.current()===o&&(t.tokenize.pop(),--t.currentIndent,n=a),n}}function tokenMacro(n,r,o){return function(e,t){return!o&&e.match("{"+n)?(t.currentIndent+=1,t.tokenize[t.tokenize.length-1]=tokenMacro(n,r,!0),"meta"):e.match(r+"}")?(--t.currentIndent,t.tokenize.pop(),"meta"):tokenBase(e,t)}}function tokenMacroDef(e,t){if(e.eatSpace())return null;var n;if(n=e.match(idents)){if("def"==n)return"keyword";e.eat(/[?!]/)}return t.tokenize.pop(),"def"}function tokenFollowIdent(e,t){return e.eatSpace()?null:(e.match(idents)?e.eat(/[!?]/):e.match(operators)||e.match(conditionalOperators)||e.match(indexingOperators),t.tokenize.pop(),"def")}function tokenFollowType(e,t){return e.eatSpace()?null:(e.match(types),t.tokenize.pop(),"def")}function tokenQuote(o,a,i){return function(e,t){for(var n=!1;e.peek();)if(n)e.next(),n=!1;else{if(e.match("{%",!1))return t.tokenize.push(tokenMacro("%","%")),a;if(e.match("{{",!1))return t.tokenize.push(tokenMacro("{","}")),a;if(i&&e.match("#{",!1))return t.tokenize.push(tokenNest("#{","}","meta")),a;var r=e.next();if(r==o)return t.tokenize.pop(),a;n=i&&"\\"==r}return a}}function tokenHereDoc(r,o){return function(e,t){if(e.sol()&&(e.eatSpace(),e.match(r)))return t.tokenize.pop(),"string";for(var n=!1;e.peek();)if(n)e.next(),n=!1;else{if(e.match("{%",!1))return t.tokenize.push(tokenMacro("%","%")),"string";if(e.match("{{",!1))return t.tokenize.push(tokenMacro("{","}")),"string";if(o&&e.match("#{",!1))return t.tokenize.push(tokenNest("#{","}","meta")),"string";n=o&&"\\"==e.next()}return"string"}}const crystal={startState:function(){return{tokenize:[tokenBase],currentIndent:0,lastToken:null,lastStyle:null,blocks:[]}},token:function(e,t){var n=t.tokenize[t.tokenize.length-1](e,t),e=e.current();return n&&"comment"!=n&&(t.lastToken=e,t.lastStyle=n),n},indent:function(e,t,n){return t=t.replace(/^\s*(?:\{%)?\s*|\s*(?:%\})?\s*$/g,""),dedentKeywords.test(t)||dedentPunctuals.test(t)?n.unit*(e.currentIndent-1):n.unit*e.currentIndent},languageData:{indentOnInput:wordRegExp(dedentPunctualsArray.concat(dedentKeywordsArray),!0),commentTokens:{line:"#"}}};export{crystal};
